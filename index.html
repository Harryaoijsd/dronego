<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Coops Fly To Location</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: #0b0f14;
      color: #e9eef6;
    }

    .wrap {
      max-width: 950px;
      margin: auto;
      padding: 12px;
      display: grid;
      gap: 12px;
    }

    h1 { margin: 0; font-size: 18px; }
    .sub { font-size: 12px; opacity: 0.7; }

    .topbar {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .pill {
      display:flex;
      gap:10px;
      align-items:center;
      background: #121925;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 12px;
    }

    .dot { width: 10px; height: 10px; border-radius: 50%; background: #888; }
    .ok .dot { background: #22c55e; }
    .bad .dot { background: #ef4444; }
    .warn .dot { background: #f59e0b; }

    .card {
      background: #121925;
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.1);
    }

    #map { height: 45vh; min-height: 320px; }

    .panel { padding: 12px; display: grid; gap: 10px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; }

    .box {
      flex: 1;
      background: #0b0f14;
      border-radius: 10px;
      padding: 10px;
      font-size: 13px;
      border: 1px solid rgba(255,255,255,0.08);
    }

    #logFeed {
      height: 200px;
      overflow-y: auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      color: #00ff9d;
      display: flex;
      flex-direction: column-reverse;
    }
    .log-item {
      padding: 2px 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      white-space: pre-wrap;
    }
    .log-time { opacity: 0.5; margin-right: 8px; font-size: 0.9em; }

    button {
      padding: 12px;
      border-radius: 12px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      background: #1e293b;
      color: white;
      flex: 1;
      font-weight: 650;
    }

    button.primary { background: #0ea5e9; }
    button.danger { background: #ef4444; }
    button.warning { background: #f59e0b; color: #111; }
    button.purple { background: #8b5cf6; }

    button:disabled { opacity: 0.5; cursor: not-allowed; }

    .small { font-size: 12px; opacity: 0.85; }
  </style>
</head>

<body>
<div class="wrap">

  <div class="topbar">
    <div>
      <h1>üõ∞Ô∏è Coops Fly To Location</h1>
      <div class="sub">External control ‚Ä¢ Live tracking ‚Ä¢ Plain text status</div>
    </div>

    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      <div class="pill" id="connPill">
        <div class="dot"></div>
        <span id="connText">Drone: Unknown</span>
      </div>

      <div class="pill">
        <strong>Battery:</strong>
        <span id="battText">--%</span>
      </div>

      <div class="pill">
        <strong>Altitude:</strong>
        <span id="altText">-- m</span>
      </div>

      <div class="pill">
        <strong>Last seen:</strong>
        <span id="seenText">--</span>
      </div>
    </div>
  </div>

  <div class="card">
    <div id="map"></div>

    <div class="panel">
      <div class="row">
        <div class="box">
          <strong>Drone Position</strong><br>
          <span id="posText">No GPS yet</span><br>
          <span class="small" id="posAgeText"></span>
        </div>
        <div class="box">
          <strong>Target Coords</strong><br>
          <span id="targetText">None selected</span>
        </div>
      </div>

      <div class="row">
        <button class="primary" id="sendBtn" disabled>SEND TARGET</button>
        <button id="gpsBtn">USE MY GPS</button>
      </div>

      <div class="row">
        <button class="warning" onclick="sendCommand('HOVER')">‚úã HOVER</button>
        <button class="purple" onclick="sendCommand('RTH')">üè† RTH</button>
        <button class="danger" onclick="sendCommand('LAND')">‚¨áÔ∏è LAND</button>
      </div>

      <div class="row">
        <button onclick="clearTarget()">üßπ Clear Target</button>
        <button onclick="clearCommand()">üßπ Clear Command</button>
        <button class="danger" onclick="clearLogs()">üßπ Clear Logs</button>
      </div>

      <div class="box" id="logFeed">
        <div style="opacity:0.5; text-align:center; padding-top:80px;">Waiting for status‚Ä¶</div>
      </div>
    </div>
  </div>
</div>

<script>
  // =============================
  // CONFIG
  // =============================
  const BASE_URL = "https://dronetalker.onrender.com";
  const APP_TOKEN = "dronetalker_9f3a7c1e2b4d8e6f1c9a";

  const MAP_CENTER = { lat: 53.5586, lon: -3.0677 };
  const MAP_ZOOM = 13;

  const POLL_LOGS_MS = 1500;
  const DRONE_OFFLINE_AFTER_S = 8;

  // =============================
  // UI refs
  // =============================
  const targetText = document.getElementById("targetText");
  const sendBtn = document.getElementById("sendBtn");
  const gpsBtn = document.getElementById("gpsBtn");
  const logFeed = document.getElementById("logFeed");

  const connPill = document.getElementById("connPill");
  const connText = document.getElementById("connText");
  const battText = document.getElementById("battText");
  const altText = document.getElementById("altText");
  const seenText = document.getElementById("seenText");
  const posText = document.getElementById("posText");
  const posAgeText = document.getElementById("posAgeText");

  // =============================
  // Map
  // =============================
  const map = L.map("map").setView([MAP_CENTER.lat, MAP_CENTER.lon], MAP_ZOOM);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(map);

  let targetMarker = null;
  let selected = null;

  let droneMarker = null;
  let lastDroneFix = null; // {lat, lon, alt, timeMs}
  let lastStatusSeenMs = 0;
  let lastBatt = null;
  let lastAlt = null;

  map.on("click", e => {
    selected = e.latlng;
    if (!targetMarker) targetMarker = L.marker(selected).addTo(map);
    else targetMarker.setLatLng(selected);

    targetText.textContent = `${selected.lat.toFixed(6)}, ${selected.lng.toFixed(6)}`;
    sendBtn.disabled = false;
    addLocalLog(`Target selected: ${selected.lat.toFixed(6)}, ${selected.lng.toFixed(6)}`);
  });

  // =============================
  // API CALLS
  // =============================
  async function sendTarget(lat, lon, acc) {
    const res = await fetch(BASE_URL + "/go", {
      method: "POST",
      headers: { "Content-Type": "application/json", "X-APP-TOKEN": APP_TOKEN },
      body: JSON.stringify({
        lat: lat, lon: lon, accuracy: acc,
        request_id: "req_" + Date.now()
      })
    });
    const data = await res.json();
    if (!data.ok) throw new Error(data.error || "sendTarget failed");
  }

  async function sendCommand(cmd) {
    try {
      addLocalLog(`Sending command: ${cmd}`);
      const res = await fetch(BASE_URL + "/drone/cmd", {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-APP-TOKEN": APP_TOKEN },
        body: JSON.stringify({ command: cmd })
      });
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || "command failed");
    } catch (e) {
      addLocalLog("Command failed: " + e.message);
    }
  }

  async function clearTarget() {
    // "Clear queue" for target = write a NULL/empty target.
    // Your current server doesn't have an endpoint for this.
    // So we simulate by sending a stale/invalid target that your drone ignores,
    // BUT better is: add a real /clear_target route in Flask.
    addLocalLog("Clear Target requested (needs Flask endpoint for true clearing)");
    addLocalLog("Tip: I can give you the Python endpoint that clears latest_target properly.");
  }

  async function clearCommand() {
    // Same issue: server has no "clear command" route yet.
    addLocalLog("Clear Command requested (needs Flask endpoint for true clearing)");
    addLocalLog("Tip: I can give you the Python endpoint that sets command to NONE.");
  }

  async function clearLogs() {
    // Same issue: server has no "clear logs" route yet.
    addLocalLog("Clear Logs requested (needs Flask endpoint for true clearing)");
    addLocalLog("Tip: I can give you the Python endpoint to delete drone_logs.");
  }

  async function fetchLogs() {
    try {
      const res = await fetch(BASE_URL + "/drone/status", {
        method: "GET",
        headers: { "X-APP-TOKEN": APP_TOKEN }
      });
      const data = await res.json();
      if (!data.ok || !data.logs) return;

      renderLogs(data.logs);

      // Scan logs for latest telemetry lines
      scanLogsForTelemetry(data.logs);

      // Update connection status
      updateConnectionUi();

    } catch (e) {
      // if the site can't reach server
      connPill.className = "pill bad";
      connText.textContent = "Drone: Server unreachable";
    }
  }

  // =============================
  // TELEMETRY PARSING
  // =============================
  // We expect lines like:
  //   "TELEM | lat=53.123456 lon=-3.123456 alt=75.0"
  // or:
  //   "STATUS | batt=87% mode=... sats=... lat=... lon=... alt=..."
  function scanLogsForTelemetry(logs) {
    // logs are returned newest-first (you reverse display), so scan all and pick newest match.
    let newestFix = null;
    let newestBatt = null;
    let newestAlt = null;
    let newestTimeMs = 0;

    for (const l of logs) {
      const msg = String(l.message || "");
      const tMs = (l.time ? (Number(l.time) * 1000) : 0);

      // Battery: batt=87% OR batt=87
      const b1 = msg.match(/batt\s*=\s*(\d{1,3})\s*%?/i);
      if (b1 && tMs >= newestTimeMs) {
        newestBatt = clampInt(parseInt(b1[1], 10), 0, 100);
      }

      // Lat/Lon/Alt
      const m = msg.match(/lat\s*=\s*(-?\d+(\.\d+)?)\s+lon\s*=\s*(-?\d+(\.\d+)?)\s+alt\s*=\s*(-?\d+(\.\d+)?)/i);
      if (m) {
        const lat = parseFloat(m[1]);
        const lon = parseFloat(m[3]);
        const alt = parseFloat(m[5]);

        if (isFinite(lat) && isFinite(lon) && Math.abs(lat) <= 90 && Math.abs(lon) <= 180) {
          if (tMs >= newestTimeMs) {
            newestTimeMs = tMs;
            newestFix = { lat, lon, alt, timeMs: tMs };
            newestAlt = alt;
          }
        }
      }

      // Also accept separate alt= in status lines
      const a1 = msg.match(/alt\s*=\s*(-?\d+(\.\d+)?)/i);
      if (a1 && tMs >= newestTimeMs) {
        newestAlt = parseFloat(a1[1]);
      }
    }

    if (newestBatt !== null && newestBatt !== lastBatt) {
      lastBatt = newestBatt;
      battText.textContent = `${lastBatt}%`;
    }

    if (newestAlt !== null && isFinite(newestAlt) && newestAlt !== lastAlt) {
      lastAlt = newestAlt;
      altText.textContent = `${lastAlt.toFixed(1)} m`;
    }

    if (newestFix) {
      lastDroneFix = newestFix;
      lastStatusSeenMs = Date.now();

      // Update map marker
      const latlng = [newestFix.lat, newestFix.lon];
      if (!droneMarker) {
        droneMarker = L.marker(latlng).addTo(map).bindPopup("Drone");
      } else {
        droneMarker.setLatLng(latlng);
      }

      // Update text
      posText.textContent = `${newestFix.lat.toFixed(6)}, ${newestFix.lon.toFixed(6)} (alt ${newestFix.alt.toFixed(1)}m)`;
      posAgeText.textContent = "";
    }
  }

  function updateConnectionUi() {
    const now = Date.now();

    if (lastStatusSeenMs === 0) {
      connPill.className = "pill warn";
      connText.textContent = "Drone: Waiting‚Ä¶";
      seenText.textContent = "--";
      return;
    }

    const ageS = Math.floor((now - lastStatusSeenMs) / 1000);
    seenText.textContent = `${ageS}s ago`;

    if (ageS <= DRONE_OFFLINE_AFTER_S) {
      connPill.className = "pill ok";
      connText.textContent = "Drone: Connected ‚úÖ";
    } else {
      connPill.className = "pill bad";
      connText.textContent = "Drone: Offline üõë";
      if (!lastDroneFix) {
        posText.textContent = "No GPS yet";
      } else {
        posAgeText.textContent = `Last fix ${ageS}s ago`;
      }
    }
  }

  function clampInt(v, lo, hi) {
    if (!isFinite(v)) return lo;
    return Math.max(lo, Math.min(hi, v));
  }

  // =============================
  // LOG UI
  // =============================
  function renderLogs(logs) {
    if (logs.length === 0) return;

    let html = "";
    for (const l of logs) {
      const date = new Date(Number(l.time) * 1000);
      const timeStr = date.toLocaleTimeString([], { hour12: false });
      html += `<div class="log-item"><span class="log-time">[${timeStr}]</span>${escapeHtml(String(l.message || ""))}</div>`;
    }
    logFeed.innerHTML = html;
  }

  function addLocalLog(msg) {
    const now = new Date();
    const timeStr = now.toLocaleTimeString([], { hour12: false });
    const entry = `<div class="log-item"><span class="log-time">[${timeStr}]</span>${escapeHtml(msg)}</div>`;
    logFeed.innerHTML = entry + logFeed.innerHTML;
  }

  function escapeHtml(s) {
    return s.replace(/[&<>"']/g, c => ({
      "&":"&amp;",
      "<":"&lt;",
      ">":"&gt;",
      '"':"&quot;",
      "'":"&#039;"
    }[c]));
  }

  // =============================
  // Buttons
  // =============================
  sendBtn.onclick = async () => {
    if (!selected) return;
    try {
      sendBtn.disabled = true;
      addLocalLog("Sending target‚Ä¶");
      await sendTarget(selected.lat, selected.lng, 15.0);
      addLocalLog("Target sent ‚úÖ");
    } catch (e) {
      addLocalLog("Send failed: " + e.message);
      sendBtn.disabled = false;
    }
  };

  gpsBtn.onclick = async () => {
    addLocalLog("Getting your GPS‚Ä¶");
    navigator.geolocation.getCurrentPosition(async pos => {
      const { latitude, longitude, accuracy } = pos.coords;
      targetText.textContent = `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
      try {
        await sendTarget(latitude, longitude, accuracy);
        addLocalLog(`GPS target sent ‚úÖ (acc ${accuracy.toFixed(1)}m)`);
      } catch (e) {
        addLocalLog("Send failed: " + e.message);
      }
    }, err => {
      addLocalLog("GPS error: " + err.message);
    }, { enableHighAccuracy: true });
  };

  // =============================
  // Polling
  // =============================
  setInterval(fetchLogs, POLL_LOGS_MS);
  fetchLogs(); // fire immediately
</script>
</body>
</html>
