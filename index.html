<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DroneTalker</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: #0b0f14;
      color: #e9eef6;
    }

    .wrap {
      max-width: 900px;
      margin: auto;
      padding: 12px;
      display: grid;
      gap: 12px;
    }

    h1 {
      margin: 0;
      font-size: 18px;
    }

    .sub {
      font-size: 12px;
      opacity: 0.7;
    }

    .card {
      background: #121925;
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.1);
    }

    #map {
      height: 55vh;
      min-height: 360px;
    }

    .panel {
      padding: 12px;
      display: grid;
      gap: 10px;
    }

    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .box {
      flex: 1;
      background: #0b0f14;
      border-radius: 10px;
      padding: 10px;
      font-size: 13px;
      border: 1px solid rgba(255,255,255,0.08);
    }

    button {
      padding: 14px;
      border-radius: 12px;
      border: none;
      font-size: 15px;
      cursor: pointer;
      background: #1e293b;
      color: white;
    }

    button.primary {
      background: #0ea5e9;
    }

    button.danger {
      background: #ef4444;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .status {
      display: flex;
      gap: 10px;
      align-items: center;
      background: #0b0f14;
      border-radius: 10px;
      padding: 10px;
      border: 1px solid rgba(255,255,255,0.08);
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #888;
    }

    .ok .dot { background: #22c55e; }
    .bad .dot { background: #ef4444; }
    .warn .dot { background: #f59e0b; }
  </style>
</head>

<body>
<div class="wrap">

  <div>
    <h1>üöÅ DroneTalker</h1>
    <div class="sub">Tap map to select target, then send</div>
  </div>

  <div class="card">
    <div id="map"></div>

    <div class="panel">

      <div class="row">
        <div class="box">
          <strong>Target</strong><br>
          <span id="targetText">None selected</span>
        </div>
        <div class="box">
          <strong>Your GPS</strong><br>
          <span id="gpsText">Not used</span>
        </div>
      </div>

      <div class="row">
        <button class="primary" id="sendBtn" disabled>Send Target</button>
        <button id="gpsBtn">Use My GPS</button>
        <button class="danger" id="clearBtn">Clear</button>
      </div>

      <div class="status" id="statusBox">
        <div class="dot"></div>
        <div>
          <div id="status1">Idle</div>
          <div id="status2" class="sub">Waiting for input</div>
        </div>
      </div>

    </div>
  </div>

</div>

<script>
  // =============================
  // CONFIG
  // =============================
  const BASE_URL = "https://dronetalker.onrender.com";
  const APP_TOKEN = "dronetalker_9f3a7c1e2b4d8e6f1c9a";

  const MAP_CENTER = { lat: 53.5586, lon: -3.0677 }; // Formby
  const MAP_ZOOM = 13;

  // =============================
  // UI refs
  // =============================
  const targetText = document.getElementById("targetText");
  const gpsText = document.getElementById("gpsText");
  const sendBtn = document.getElementById("sendBtn");
  const gpsBtn = document.getElementById("gpsBtn");
  const clearBtn = document.getElementById("clearBtn");
  const statusBox = document.getElementById("statusBox");
  const status1 = document.getElementById("status1");
  const status2 = document.getElementById("status2");

  function setStatus(type, l1, l2) {
    statusBox.className = "status " + (type || "");
    status1.textContent = l1;
    status2.textContent = l2 || "";
  }

  function reqId() {
    return "req_" + Date.now() + "_" + Math.random().toString(16).slice(2);
  }

  async function send(lat, lon, acc) {
    const res = await fetch(BASE_URL + "/go", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-APP-TOKEN": APP_TOKEN
      },
      body: JSON.stringify({
        lat: lat,
        lon: lon,
        accuracy: acc,
        request_id: reqId()
      })
    });

    const data = await res.json();
    if (!res.ok || !data.ok) {
      throw new Error(data.error || "Send failed");
    }
  }

  // =============================
  // Map
  // =============================
  const map = L.map("map").setView([MAP_CENTER.lat, MAP_CENTER.lon], MAP_ZOOM);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19
  }).addTo(map);

  let marker = null;
  let selected = null;

  map.on("click", e => {
    selected = e.latlng;
    if (!marker) {
      marker = L.marker(selected).addTo(map);
    } else {
      marker.setLatLng(selected);
    }
    targetText.textContent = `${selected.lat.toFixed(6)}, ${selected.lng.toFixed(6)}`;
    sendBtn.disabled = false;
    setStatus(null, "Target selected", "Ready to send");
  });

  clearBtn.onclick = () => {
    if (marker) map.removeLayer(marker);
    marker = null;
    selected = null;
    sendBtn.disabled = true;
    targetText.textContent = "None selected";
    setStatus(null, "Cleared", "Pick a new target");
  };

  sendBtn.onclick = async () => {
    try {
      sendBtn.disabled = true;
      setStatus("warn", "Sending‚Ä¶", targetText.textContent);
      await send(selected.lat, selected.lng, 15.0);
      setStatus("ok", "Sent ‚úÖ", targetText.textContent);
    } catch (e) {
      setStatus("bad", "Failed ‚ùå", e.message);
      sendBtn.disabled = false;
    }
  };

  gpsBtn.onclick = async () => {
    try {
      setStatus("warn", "Getting GPS‚Ä¶");
      const pos = await new Promise((res, rej) =>
        navigator.geolocation.getCurrentPosition(res, rej, {
          enableHighAccuracy: true,
          timeout: 15000
        })
      );
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      const acc = pos.coords.accuracy;

      gpsText.textContent = `${lat.toFixed(6)}, ${lon.toFixed(6)} ¬±${acc.toFixed(1)}m`;
      await send(lat, lon, acc);
      setStatus("ok", "Sent GPS ‚úÖ", gpsText.textContent);
    } catch (e) {
      setStatus("bad", "GPS failed ‚ùå", e.message);
    }
  };
</script>
</body>
</html>
