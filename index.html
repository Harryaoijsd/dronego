<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DroneTalker</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: #0b0f14;
      color: #e9eef6;
    }

    .wrap {
      max-width: 900px;
      margin: auto;
      padding: 12px;
      display: grid;
      gap: 12px;
    }

    h1 { margin: 0; font-size: 18px; }
    .sub { font-size: 12px; opacity: 0.7; }

    .card {
      background: #121925;
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.1);
    }

    #map { height: 45vh; min-height: 300px; }

    .panel { padding: 12px; display: grid; gap: 10px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; }

    .box {
      flex: 1;
      background: #0b0f14;
      border-radius: 10px;
      padding: 10px;
      font-size: 13px;
      border: 1px solid rgba(255,255,255,0.08);
    }

    /* Log Feed Styles */
    #logFeed {
        height: 150px;
        overflow-y: auto;
        font-family: monospace;
        color: #00ff9d;
        display: flex;
        flex-direction: column-reverse; /* Newest at bottom visually if desired, or top */
    }
    .log-item {
        padding: 2px 0;
        border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .log-time { opacity: 0.5; margin-right: 8px; font-size: 0.9em; }

    button {
      padding: 14px;
      border-radius: 12px;
      border: none;
      font-size: 15px;
      cursor: pointer;
      background: #1e293b;
      color: white;
      flex: 1;
      font-weight: 600;
    }

    button.primary { background: #0ea5e9; }
    button.danger { background: #ef4444; }
    button.warning { background: #f59e0b; color: #111; }
    button.purple { background: #8b5cf6; }

    button:disabled { opacity: 0.5; cursor: not-allowed; }

    .status {
      display: flex; gap: 10px; align-items: center;
      background: #0b0f14; border-radius: 10px; padding: 10px;
      border: 1px solid rgba(255,255,255,0.08);
    }
    .dot { width: 10px; height: 10px; border-radius: 50%; background: #888; }
    .ok .dot { background: #22c55e; }
    .bad .dot { background: #ef4444; }
    .warn .dot { background: #f59e0b; }
  </style>
</head>

<body>
<div class="wrap">

  <div style="display:flex; justify-content:space-between; align-items:center;">
    <div>
      <h1>üöÅ DroneTalker</h1>
      <div class="sub">Control & Monitor</div>
    </div>
    <div class="status" id="statusBox" style="padding: 5px 10px;">
        <div class="dot"></div>
        <span id="status1" style="font-size:12px">Ready</span>
    </div>
  </div>

  <div class="card">
    <div id="map"></div>
    
    <div class="panel">
      <div class="row">
        <div class="box">
          <strong>Target Coords</strong><br>
          <span id="targetText">None selected</span>
        </div>
      </div>

      <div class="row">
        <button class="primary" id="sendBtn" disabled>FLY TO TARGET</button>
        <button id="gpsBtn">USE MY GPS</button>
      </div>

      <div class="row" style="margin-top:10px; border-top: 1px solid rgba(255,255,255,0.1); padding-top:10px;">
        <button class="warning" onclick="sendCommand('HOVER')">‚úã HOVER</button>
        <button class="purple" onclick="sendCommand('RTH')">üè† RTH</button>
      </div>
      
      <div class="box" id="logFeed">
        <div style="opacity:0.5; text-align:center; padding-top:60px;">Waiting for drone connection...</div>
      </div>

    </div>
  </div>
</div>

<script>
  // =============================
  // CONFIG
  // =============================
  const BASE_URL = "https://dronetalker.onrender.com"; // Change if running locally
  const APP_TOKEN = "dronetalker_9f3a7c1e2b4d8e6f1c9a";

  const MAP_CENTER = { lat: 53.5586, lon: -3.0677 };
  const MAP_ZOOM = 13;

  // =============================
  // UI refs
  // =============================
  const targetText = document.getElementById("targetText");
  const sendBtn = document.getElementById("sendBtn");
  const gpsBtn = document.getElementById("gpsBtn");
  const statusBox = document.getElementById("statusBox");
  const status1 = document.getElementById("status1");
  const logFeed = document.getElementById("logFeed");

  function setStatus(type, text) {
    statusBox.className = "status " + (type || "");
    status1.textContent = text;
  }

  // =============================
  // API CALLS
  // =============================
  
  // 1. Send Coordinates (Existing)
  async function sendTarget(lat, lon, acc) {
    const res = await fetch(BASE_URL + "/go", {
      method: "POST",
      headers: { "Content-Type": "application/json", "X-APP-TOKEN": APP_TOKEN },
      body: JSON.stringify({
        lat: lat, lon: lon, accuracy: acc,
        request_id: "req_" + Date.now()
      })
    });
    const data = await res.json();
    if (!data.ok) throw new Error(data.error);
  }

  // 2. Send Command (Hover / RTH)
  async function sendCommand(cmd) {
    try {
        setStatus("warn", "Sending " + cmd + "...");
        const res = await fetch(BASE_URL + "/drone/cmd", {
            method: "POST",
            headers: { "Content-Type": "application/json", "X-APP-TOKEN": APP_TOKEN },
            body: JSON.stringify({ command: cmd })
        });
        const data = await res.json();
        if (data.ok) {
            setStatus("ok", cmd + " Sent!");
            // Manually add to log for immediate feedback
            addLogToUI(`Command sent: ${cmd}`, Date.now()/1000);
        }
    } catch (e) {
        setStatus("bad", "Cmd Failed");
    }
  }

  // 3. Poll for Logs
  async function fetchLogs() {
    try {
        const res = await fetch(BASE_URL + "/drone/status", {
            method: "GET",
            headers: { "X-APP-TOKEN": APP_TOKEN }
        });
        const data = await res.json();
        if (data.ok && data.logs) {
            renderLogs(data.logs);
        }
    } catch (e) {
        console.log("Log fetch error", e);
    }
  }

  // =============================
  // UI LOGIC
  // =============================

  // Poll logs every 2 seconds
  setInterval(fetchLogs, 2000);

  function renderLogs(logs) {
      if(logs.length === 0) return;
      
      let html = "";
      // Server returns newest first. 
      logs.forEach(l => {
          const date = new Date(l.time * 1000);
          const timeStr = date.toLocaleTimeString([], { hour12: false });
          html += `<div class="log-item"><span class="log-time">[${timeStr}]</span> ${l.message}</div>`;
      });
      logFeed.innerHTML = html;
  }
  
  function addLogToUI(msg, timestamp) {
      const date = new Date(timestamp * 1000);
      const timeStr = date.toLocaleTimeString([], { hour12: false });
      const entry = `<div class="log-item"><span class="log-time">[${timeStr}]</span> ${msg}</div>`;
      logFeed.innerHTML = entry + logFeed.innerHTML;
  }

  // =============================
  // MAP LOGIC
  // =============================
  const map = L.map("map").setView([MAP_CENTER.lat, MAP_CENTER.lon], MAP_ZOOM);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(map);

  let marker = null;
  let selected = null;

  map.on("click", e => {
    selected = e.latlng;
    if (!marker) marker = L.marker(selected).addTo(map);
    else marker.setLatLng(selected);
    
    targetText.textContent = `${selected.lat.toFixed(5)}, ${selected.lng.toFixed(5)}`;
    sendBtn.disabled = false;
    sendBtn.textContent = "FLY TO TARGET";
    setStatus("ok", "Target Set");
  });

  sendBtn.onclick = async () => {
    try {
      sendBtn.disabled = true;
      setStatus("warn", "Sending...");
      await sendTarget(selected.lat, selected.lng, 15.0);
      setStatus("ok", "Sent Success");
      sendBtn.textContent = "SENT";
    } catch (e) {
      setStatus("bad", "Failed");
      sendBtn.disabled = false;
    }
  };

  gpsBtn.onclick = async () => {
    setStatus("warn", "Locating...");
    navigator.geolocation.getCurrentPosition(async pos => {
        const { latitude, longitude, accuracy } = pos.coords;
        targetText.textContent = `${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;
        try {
            await sendTarget(latitude, longitude, accuracy);
            setStatus("ok", "GPS Sent");
        } catch(e) {
            setStatus("bad", "Send Fail");
        }
    }, err => {
        setStatus("bad", "GPS Error");
    }, { enableHighAccuracy: true });
  };
</script>
</body>
</html>