<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DroneTalker</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: #0b0f14;
      color: #e9eef6;
    }

    .wrap {
      max-width: 980px;
      margin: auto;
      padding: 12px;
      display: grid;
      gap: 12px;
    }

    .topbar {
      display:flex; justify-content:space-between; align-items:center; gap: 10px; flex-wrap: wrap;
    }

    h1 { margin: 0; font-size: 18px; }
    .sub { font-size: 12px; opacity: 0.7; }

    .pill {
      display:flex; gap:10px; align-items:center;
      background:#0b0f14; border-radius:12px; padding:10px 12px;
      border:1px solid rgba(255,255,255,0.08);
      font-size: 12px;
      white-space: nowrap;
    }
    .dot { width: 10px; height: 10px; border-radius: 50%; background:#888; }
    .ok .dot { background:#22c55e; }
    .bad .dot { background:#ef4444; }
    .warn .dot { background:#f59e0b; }

    .card {
      background: #121925;
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.1);
    }

    #map { height: 50vh; min-height: 340px; }

    .panel { padding: 12px; display: grid; gap: 10px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; }

    .box {
      flex: 1;
      background: #0b0f14;
      border-radius: 10px;
      padding: 10px;
      font-size: 13px;
      border: 1px solid rgba(255,255,255,0.08);
    }

    #logFeed {
      height: 180px;
      overflow-y: auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      color: #00ff9d;
      background: #0b0f14;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.08);
      padding: 10px;
    }

    .log-item {
      padding: 3px 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .log-time { opacity: 0.5; margin-right: 8px; font-size: 0.9em; }

    button {
      padding: 14px;
      border-radius: 12px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      background: #1e293b;
      color: white;
      flex: 1;
      font-weight: 700;
    }

    button.primary { background: #0ea5e9; }
    button.danger { background: #ef4444; }
    button.warning { background: #f59e0b; color: #111; }
    button.purple { background: #8b5cf6; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }

    .mini { flex: 0 0 auto; padding: 10px 12px; font-weight: 700; }
  </style>
</head>

<body>
<div class="wrap">

  <div class="topbar">
    <div>
      <h1>üöÅ DroneTalker</h1>
      <div class="sub">Target + Commands + Live Telemetry</div>
    </div>

    <div class="pill" id="connPill">
      <div class="dot"></div>
      <span id="connText">Drone: unknown</span>
    </div>

    <div class="pill">
      <strong>Battery:</strong> <span id="battText">--%</span>
      &nbsp;|&nbsp;
      <strong>Alt:</strong> <span id="altText">-- m</span>
      &nbsp;|&nbsp;
      <strong>Sats:</strong> <span id="satsText">--</span>
    </div>
  </div>

  <div class="card">
    <div id="map"></div>

    <div class="panel">

      <div class="row">
        <div class="box">
          <strong>Target Coords</strong><br>
          <span id="targetText">None selected</span>
        </div>

        <div class="box">
          <strong>Drone Coords</strong><br>
          <span id="droneText">--</span><br>
          <span style="opacity:0.7" id="phaseText">phase: --</span>
        </div>
      </div>

      <div class="row">
        <button class="primary" id="sendBtn" disabled>FLY TO TARGET</button>
        <button id="gpsBtn">USE MY GPS</button>
        <button class="mini danger" onclick="clearTarget()">CLEAR TARGET</button>
      </div>

      <div class="row">
        <button class="warning" onclick="sendCommand('HOVER')">‚úã HOVER</button>
        <button class="purple" onclick="sendCommand('RTH')">üè† RTH</button>
        <button class="danger" onclick="sendCommand('LAND')">‚¨áÔ∏è LAND</button>
        <button class="mini danger" onclick="clearCommand()">CLEAR CMD</button>
      </div>

      <div class="row">
        <button class="danger" onclick="clearLogs()">üßπ CLEAR LOGS</button>
      </div>

      <div id="logFeed">
        <div style="opacity:0.6; text-align:center; padding-top:60px;">Waiting for logs‚Ä¶</div>
      </div>

    </div>
  </div>
</div>

<script>
  // =============================
  // CONFIG
  // =============================
  const BASE_URL = "https://dronetalker.onrender.com";
  const APP_TOKEN = "dronetalker_9f3a7c1e2b4d8e6f1c9a";

  const MAP_CENTER = { lat: 53.5586, lon: -3.0677 };
  const MAP_ZOOM = 13;

  // =============================
  // UI refs
  // =============================
  const targetText = document.getElementById("targetText");
  const droneText  = document.getElementById("droneText");
  const phaseText  = document.getElementById("phaseText");

  const sendBtn = document.getElementById("sendBtn");
  const gpsBtn = document.getElementById("gpsBtn");
  const logFeed = document.getElementById("logFeed");

  const connPill = document.getElementById("connPill");
  const connText = document.getElementById("connText");

  const battText = document.getElementById("battText");
  const altText  = document.getElementById("altText");
  const satsText = document.getElementById("satsText");

  function setConn(type, text) {
    connPill.className = "pill " + (type || "");
    connText.textContent = text;
  }

  // =============================
  // MAP
  // =============================
  const map = L.map("map").setView([MAP_CENTER.lat, MAP_CENTER.lon], MAP_ZOOM);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(map);

  let targetMarker = null;
  let droneMarker  = null;
  let selected = null;

  // simple drone icon (emoji pin)
  const droneIcon = L.divIcon({
    className: "",
    html: `<div style="
      font-size:26px;
      transform: translate(-50%, -50%);
      filter: drop-shadow(0 2px 3px rgba(0,0,0,0.6));
    ">üöÅ</div>`,
    iconSize: [30, 30],
    iconAnchor: [15, 15]
  });

  map.on("click", e => {
    selected = e.latlng;
    if (!targetMarker) targetMarker = L.marker(selected).addTo(map);
    else targetMarker.setLatLng(selected);

    targetText.textContent = `${selected.lat.toFixed(5)}, ${selected.lng.toFixed(5)}`;
    sendBtn.disabled = false;
    sendBtn.textContent = "FLY TO TARGET";
  });

  // =============================
  // API
  // =============================
  async function apiGet(path) {
    const res = await fetch(BASE_URL + path, {
      method: "GET",
      headers: { "X-APP-TOKEN": APP_TOKEN }
    });
    return await res.json();
  }

  async function apiPost(path, bodyObj) {
    const res = await fetch(BASE_URL + path, {
      method: "POST",
      headers: { "Content-Type": "application/json", "X-APP-TOKEN": APP_TOKEN },
      body: JSON.stringify(bodyObj || {})
    });
    return await res.json();
  }

  async function sendTarget(lat, lon, acc) {
    const data = await apiPost("/go", {
      lat, lon, accuracy: acc,
      request_id: "req_" + Date.now()
    });
    if (!data.ok) throw new Error(data.error || "send failed");
  }

  async function sendCommand(cmd) {
    try {
      const data = await apiPost("/drone/cmd", { command: cmd });
      if (!data.ok) throw new Error(data.error || "cmd failed");
      addLogToUI(`Command sent: ${cmd}`, Date.now()/1000);
    } catch (e) {
      addLogToUI(`Cmd failed: ${e.message}`, Date.now()/1000);
    }
  }

  async function clearLogs() {
    const data = await apiPost("/drone/logs/clear", {});
    if (data.ok) {
      logFeed.innerHTML = `<div style="opacity:0.6;text-align:center;padding:20px;">Logs cleared</div>`;
    }
  }

  async function clearTarget() {
    const data = await apiPost("/go/clear", {});
    if (data.ok) {
      addLogToUI("Target queue cleared üßπ", Date.now()/1000);
      targetText.textContent = "None selected";
      if (targetMarker) { map.removeLayer(targetMarker); targetMarker = null; }
      selected = null;
      sendBtn.disabled = true;
      sendBtn.textContent = "FLY TO TARGET";
    }
  }

  async function clearCommand() {
    const data = await apiPost("/drone/cmd/clear", {});
    if (data.ok) addLogToUI("Command queue cleared üßπ", Date.now()/1000);
  }

  // =============================
  // UI actions
  // =============================
  sendBtn.onclick = async () => {
    if (!selected) return;
    try {
      sendBtn.disabled = true;
      await sendTarget(selected.lat, selected.lng, 15.0);
      sendBtn.textContent = "SENT";
      addLogToUI(`Target sent: ${selected.lat.toFixed(5)}, ${selected.lng.toFixed(5)}`, Date.now()/1000);
    } catch (e) {
      sendBtn.disabled = false;
      addLogToUI(`Target send failed: ${e.message}`, Date.now()/1000);
    }
  };

  gpsBtn.onclick = async () => {
    navigator.geolocation.getCurrentPosition(async pos => {
      const { latitude, longitude, accuracy } = pos.coords;
      targetText.textContent = `${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;
      try {
        await sendTarget(latitude, longitude, accuracy);
        addLogToUI(`GPS target sent: ${latitude.toFixed(5)}, ${longitude.toFixed(5)}`, Date.now()/1000);
      } catch (e) {
        addLogToUI(`GPS send failed: ${e.message}`, Date.now()/1000);
      }
    }, _ => {
      addLogToUI("GPS error", Date.now()/1000);
    }, { enableHighAccuracy: true });
  };

  // =============================
  // LOGS
  // =============================
  function renderLogs(logs) {
    if (!logs || logs.length === 0) return;

    let html = "";
    logs.forEach(l => {
      const date = new Date(l.time * 1000);
      const timeStr = date.toLocaleTimeString([], { hour12: false });
      html += `<div class="log-item"><span class="log-time">[${timeStr}]</span>${escapeHtml(l.message)}</div>`;
    });
    logFeed.innerHTML = html;
  }

  function addLogToUI(msg, timestamp) {
    const date = new Date(timestamp * 1000);
    const timeStr = date.toLocaleTimeString([], { hour12: false });
    const entry = `<div class="log-item"><span class="log-time">[${timeStr}]</span>${escapeHtml(msg)}</div>`;
    logFeed.innerHTML = entry + logFeed.innerHTML;
  }

  function escapeHtml(s) {
    return String(s)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;");
  }

  async function fetchLogs() {
    try {
      const data = await apiGet("/drone/status");
      if (data.ok && data.logs) renderLogs(data.logs);
    } catch (e) {}
  }

  // =============================
  // TELEMETRY (battery/alt/position)
  // =============================
  async function fetchTelemetry() {
    try {
      const data = await apiGet("/drone/telemetry");
      if (!data.ok || !data.telemetry) return;

      const t = data.telemetry;

      // connected indicator based on telemetry age
      if (t.connected) setConn("ok", "Drone: connected");
      else setConn("bad", "Drone: not updating");

      // battery / alt / sats
      battText.textContent = (t.batt === null || t.batt === undefined) ? "--%" : `${t.batt}%`;
      altText.textContent  = (t.alt === null || t.alt === undefined) ? "-- m" : `${Number(t.alt).toFixed(1)} m`;
      satsText.textContent = (t.sats === null || t.sats === undefined) ? "--" : String(t.sats);

      // drone pos
      if (t.lat != null && t.lon != null) {
        droneText.textContent = `${Number(t.lat).toFixed(5)}, ${Number(t.lon).toFixed(5)}`;
        phaseText.textContent = `phase: ${t.phase || "--"} | flying: ${t.flying}`;

        const ll = L.latLng(t.lat, t.lon);
        if (!droneMarker) droneMarker = L.marker(ll, { icon: droneIcon }).addTo(map);
        else droneMarker.setLatLng(ll);
      }
    } catch (e) {}
  }

  // Poll loops
  setInterval(fetchLogs, 2000);
  setInterval(fetchTelemetry, 1000);

  // kick once immediately
  fetchLogs();
  fetchTelemetry();
</script>
</body>
</html>
